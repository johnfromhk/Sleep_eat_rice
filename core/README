这部分是核心算法，详见代码
